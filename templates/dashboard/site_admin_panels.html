{% extends "dashboard/base_dashboard.html" %}

{% block title %}Site Administrator Dashboard - CEI Course Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='panels.css') }}">
{% endblock %}

{% block nav_items %}
<a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
<a class="nav-link" href="#" onclick="showInstitutions()"><i class="fas fa-university me-1"></i>Institutions</a>
<a class="nav-link" href="#" onclick="showUsers()"><i class="fas fa-users me-1"></i>Users</a>
<a class="nav-link" href="#" onclick="showSystemSettings()"><i class="fas fa-cogs me-1"></i>System</a>
{% endblock %}

{% block page_title %}üèõÔ∏è Site Administration{% endblock %}
{% block page_subtitle %}System-wide oversight and configuration{% endblock %}

{% block content %}
<!-- Interactive Header Stats -->
<div class="header-stats">
    <span>Current Term: <strong>Fall 2024</strong></span>
    <div class="stat-item" data-stat="institutions">
        [<span class="stat-number" id="institutionCount">0</span> Institutions]
    </div>
    <div class="stat-item" data-stat="programs">
        [<span class="stat-number" id="programCount">0</span> Programs]
    </div>
    <div class="stat-item" data-stat="courses">
        [<span class="stat-number" id="courseCount">0</span> Courses]
    </div>
    <div class="stat-item" data-stat="users">
        [<span class="stat-number" id="userCount">0</span> Users]
    </div>
</div>

<!-- Panel 1: Institution Overview -->
<div class="dashboard-panel" id="institution-overview-panel">
    <div class="panel-header">
        <h5 class="panel-title">
            <span class="panel-icon">üèõÔ∏è</span>
            Institution Management
        </h5>
        <div class="panel-actions">
            <button class="btn btn-sm btn-primary" onclick="createInstitution()">
                <i class="fas fa-plus"></i> Add Institution
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="institutionSettings()">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
        <button class="panel-toggle">‚ñº</button>
    </div>
    <div class="panel-content">
        <div id="institutionTableContainer">
            <div class="panel-loading">
                <div class="spinner-border spinner-border-sm"></div>
                Loading institutions...
            </div>
        </div>
    </div>
</div>

<!-- Panel 2: System Activity -->
<div class="dashboard-panel" id="system-activity-panel">
    <div class="panel-header">
        <h5 class="panel-title">
            <span class="panel-icon">üìä</span>
            Recent System Activity
        </h5>
        <div class="panel-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="viewAllActivity()">
                <i class="fas fa-list"></i> View All
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="filterActivity()">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
        <button class="panel-toggle">‚ñº</button>
    </div>
    <div class="panel-content">
        <div id="activityTableContainer">
            <div class="panel-loading">
                <div class="spinner-border spinner-border-sm"></div>
                Loading system activity...
            </div>
        </div>
    </div>
</div>

<!-- Panel 3: User Management -->
<div class="dashboard-panel" id="user-management-panel">
    <div class="panel-header">
        <h5 class="panel-title">
            <span class="panel-icon">üë•</span>
            User Management
        </h5>
        <div class="panel-actions">
            <button class="btn btn-sm btn-success" onclick="inviteUser()">
                <i class="fas fa-user-plus"></i> Add User
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="bulkImport()">
                <i class="fas fa-upload"></i> Bulk Import
            </button>
        </div>
        <button class="panel-toggle">‚ñº</button>
    </div>
    <div class="panel-content">
        <div id="userTableContainer">
            <div class="panel-loading">
                <div class="spinner-border spinner-border-sm"></div>
                Loading users...
            </div>
        </div>
    </div>
</div>

<!-- Panel 4: Data Export (Collapsed by default) -->
<div class="dashboard-panel" id="data-export-panel">
    <div class="panel-header">
        <h5 class="panel-title">
            <span class="panel-icon">üìÑ</span>
            Data Export
        </h5>
        <div class="panel-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="quickExport()">
                <i class="fas fa-download"></i> Quick Export
            </button>
        </div>
        <button class="panel-toggle">‚ñ≤</button>
    </div>
    <div class="panel-content collapsed">
        <div class="row">
            <div class="col-md-6">
                <h6>Quick Export Options</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData('users')">
                        <i class="fas fa-users"></i> All Users
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData('institutions')">
                        <i class="fas fa-university"></i> All Institutions
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData('activity')">
                        <i class="fas fa-chart-line"></i> System Activity
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Export Formats</h6>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatCSV" value="csv" checked>
                    <label class="form-check-label" for="formatCSV">CSV</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="excel">
                    <label class="form-check-label" for="formatExcel">Excel</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatJSON" value="json">
                    <label class="form-check-label" for="formatJSON">JSON</label>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='panels.js') }}"></script>
<script>
    // Site Admin Dashboard with Panel-Based UI
    document.addEventListener('DOMContentLoaded', function() {
        loadSiteAdminData();
    });

    async function loadSiteAdminData() {
        try {
            await Promise.all([
                loadHeaderStats(),
                loadInstitutionTable(),
                loadSystemActivity(),
                loadUserTable()
            ]);
        } catch (error) {
            console.error('Error loading site admin data:', error);
        }
    }

    async function loadHeaderStats() {
        try {
            const [institutionsResp, programsResp, coursesResp, usersResp] = await Promise.all([
                fetch('/api/institutions', { credentials: 'include' }),
                fetch('/api/programs', { credentials: 'include' }),
                fetch('/api/courses', { credentials: 'include' }),
                fetch('/api/users', { credentials: 'include' })
            ]);

            const [institutions, programs, courses, users] = await Promise.all([
                institutionsResp.json(),
                programsResp.json(),
                coursesResp.json(),
                usersResp.json()
            ]);

            document.getElementById('institutionCount').textContent = institutions.institutions?.length || 0;
            document.getElementById('programCount').textContent = programs.programs?.length || 0;
            document.getElementById('courseCount').textContent = courses.courses?.length || 0;
            document.getElementById('userCount').textContent = users.users?.length || 0;
        } catch (error) {
            console.error('Error loading header stats:', error);
        }
    }

    async function loadInstitutionTable() {
        try {
            const response = await fetch('/api/institutions', { credentials: 'include' });
            const data = await response.json();
            
            const container = document.getElementById('institutionTableContainer');
            
            if (data.success && data.institutions && data.institutions.length > 0) {
                const table = panelManager.createSortableTable({
                    id: 'institutions-table',
                    columns: [
                        { key: 'name', label: 'Institution', sortable: true },
                        { key: 'user_count', label: 'Users', sortable: true },
                        { key: 'program_count', label: 'Programs', sortable: true },
                        { key: 'course_count', label: 'Courses', sortable: true },
                        { key: 'status', label: 'Status', sortable: true },
                        { key: 'actions', label: 'Actions', sortable: false }
                    ],
                    data: data.institutions.map(inst => ({
                        name: inst.name,
                        user_count: inst.user_count || 0,
                        program_count: inst.program_count || 0,
                        course_count: inst.course_count || 0,
                        status: '<span class="status-badge active">Active</span>',
                        actions: `<button class="btn btn-sm btn-outline-primary" onclick="editInstitution('${inst.institution_id}')"><i class="fas fa-edit"></i></button>`
                    }))
                });
                
                container.innerHTML = '';
                container.appendChild(table);
            } else {
                container.innerHTML = `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">üèõÔ∏è</div>
                        <p>No institutions found</p>
                        <button class="btn btn-primary" onclick="createInstitution()">Create First Institution</button>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('institutionTableContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading institutions
                </div>
            `;
        }
    }

    async function loadSystemActivity() {
        try {
            // Mock system activity data - in real implementation, this would come from an API
            const mockActivity = [
                { timestamp: '2:34 PM', institution: 'CEI', user: 'Sarah Johnson', action: 'CLO Assessment', details: 'CS-101' },
                { timestamp: '1:15 PM', institution: 'RCC', user: 'Mike Admin', action: 'User Created', details: 'New Instructor' },
                { timestamp: '11:30 AM', institution: 'PTU', user: 'System', action: 'Term Created', details: 'Spring 2025' },
                { timestamp: '10:45 AM', institution: 'CEI', user: 'John Smith', action: 'CLO Completed', details: 'EE-101.2' }
            ];
            
            const container = document.getElementById('activityTableContainer');
            
            const table = panelManager.createSortableTable({
                id: 'activity-table',
                columns: [
                    { key: 'timestamp', label: 'Timestamp', sortable: true },
                    { key: 'institution', label: 'Institution', sortable: true },
                    { key: 'user', label: 'User', sortable: true },
                    { key: 'action', label: 'Action', sortable: true },
                    { key: 'details', label: 'Details', sortable: false }
                ],
                data: mockActivity
            });
            
            container.innerHTML = '';
            container.appendChild(table);
        } catch (error) {
            document.getElementById('activityTableContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading system activity
                </div>
            `;
        }
    }

    async function loadUserTable() {
        try {
            const response = await fetch('/api/users', { credentials: 'include' });
            const data = await response.json();
            
            const container = document.getElementById('userTableContainer');
            
            if (data.success && data.users && data.users.length > 0) {
                const table = panelManager.createSortableTable({
                    id: 'users-table',
                    columns: [
                        { key: 'name', label: 'Name', sortable: true },
                        { key: 'email', label: 'Email', sortable: true },
                        { key: 'role', label: 'Role', sortable: true },
                        { key: 'institution', label: 'Institution', sortable: true },
                        { key: 'status', label: 'Status', sortable: true }
                    ],
                    data: data.users.map(user => ({
                        name: `${user.first_name} ${user.last_name}`,
                        email: user.email,
                        role: user.role.replace('_', ' '),
                        institution: user.institution_name || 'N/A',
                        status: '<span class="status-badge active">Active</span>'
                    }))
                });
                
                container.innerHTML = '';
                container.appendChild(table);
            } else {
                container.innerHTML = `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">üë•</div>
                        <p>No users found</p>
                        <button class="btn btn-success" onclick="inviteUser()">Invite First User</button>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('userTableContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading users
                </div>
            `;
        }
    }

    // Action Functions
    function createInstitution() {
        alert('Create Institution feature coming soon!');
    }

    function institutionSettings() {
        alert('Institution Settings feature coming soon!');
    }

    function editInstitution(id) {
        alert(`Edit Institution ${id} feature coming soon!`);
    }

    function viewAllActivity() {
        alert('View All Activity feature coming soon!');
    }

    function filterActivity() {
        alert('Filter Activity feature coming soon!');
    }

    function inviteUser() {
        alert('Invite User feature coming soon!');
    }

    function bulkImport() {
        alert('Bulk Import feature coming soon!');
    }

    function quickExport() {
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        alert(`Quick Export (${format}) feature coming soon!`);
    }

    function exportData(type) {
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        alert(`Export ${type} (${format}) feature coming soon!`);
    }

    function showInstitutions() {
        alert('Institutions management feature coming soon!');
    }

    function showUsers() {
        alert('Users management feature coming soon!');
    }

    function showSystemSettings() {
        alert('System Settings feature coming soon!');
    }
</script>
{% endblock %}
