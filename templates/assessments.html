{% extends "dashboard/base_dashboard.html" %}

{% block title %}Course Assessments{% endblock %}

{% block extra_css %}
<style>
    .outcomes-list .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .outcomes-list .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    .bg-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    .text-primary {
        color: #667eea !important;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #5568d3 0%, #63398b 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .border-start {
        border-left-width: 4px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Course Assessments</h1>
    <p class="lead">View and update outcome assessments for your sections</p>
    
    <!-- Course Selector -->
    <div class="mb-4">
        <label for="courseSelect" class="form-label">Select Course:</label>
        <select class="form-select" id="courseSelect">
            <option value="">Loading courses...</option>
        </select>
    </div>
    
    <!-- Course-Level Assessment Section (NEW from CEI demo feedback) -->
    <div id="courseLevelSection" style="display: none;" class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-chart-line"></i> Course-Level Assessment Data</h5>
        </div>
        <div class="card-body">
            <!-- Enrollment Information (Read-Only) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h6 class="text-primary mb-3">Enrollment Information (Pre-Populated)</h6>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Total Enrollment:</label>
                    <input type="text" class="form-control-plaintext" id="courseEnrollment" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Withdrawals:</label>
                    <input type="text" class="form-control-plaintext" id="courseWithdrawals" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Assessment Due Date:</label>
                    <input type="text" class="form-control-plaintext" id="courseDueDate" readonly>
                    <small class="text-muted">Set by program admin</small>
                </div>
            </div>
            
            <!-- Grade Outcomes (Instructor Input) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h6 class="text-primary mb-3">Course Grade Outcomes (Instructor Input)</h6>
                </div>
                <div class="col-md-6">
                    <label for="studentsPassed" class="form-label">Students Passed (A/B/C) *</label>
                    <input type="number" class="form-control" id="courseStudentsPassed" min="0" placeholder="Number of students with A, B, or C">
                </div>
                <div class="col-md-6">
                    <label for="studentsDFIC" class="form-label">Students D/F/Incomplete *</label>
                    <input type="number" class="form-control" id="courseStudentsDFIC" min="0" placeholder="Number of students with D, F, or I">
                </div>
            </div>
            
            <!-- Reconciliation -->
            <div class="mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cannotReconcile">
                    <label class="form-check-label" for="cannotReconcile">
                        <strong>Cannot Reconcile</strong> - Check if enrollment numbers don't add up
                    </label>
                </div>
                <div id="reconciliationNoteContainer" style="display: none;" class="mt-2">
                    <label for="reconciliationNote" class="form-label">Reconciliation Note:</label>
                    <textarea class="form-control" id="reconciliationNote" rows="2" placeholder="Explain why the numbers don't reconcile..."></textarea>
                </div>
            </div>
            
            <!-- Course Narratives (NOT at CLO level - corrected from demo feedback) -->
            <div class="mb-3">
                <h6 class="text-primary mb-3">Course Reflections</h6>
                
                <div class="mb-3">
                    <label for="narrativeCelebrations" class="form-label">What Went Well (Celebrations)?</label>
                    <textarea class="form-control" id="narrativeCelebrations" rows="3" placeholder="Describe what worked well in this course..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="narrativeChallenges" class="form-label">What Was Difficult (Challenges)?</label>
                    <textarea class="form-control" id="narrativeChallenges" rows="3" placeholder="Describe challenges encountered..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="narrativeChanges" class="form-label">What to Do Differently (Changes)?</label>
                    <textarea class="form-control" id="narrativeChanges" rows="3" placeholder="Describe what you would change next time..."></textarea>
                </div>
            </div>
            
            <div class="text-end">
                <button type="button" class="btn btn-primary" id="saveCourseData"><i class="fas fa-save"></i> Save Course Data</button>
            </div>
        </div>
    </div>
    
    <!-- Outcomes List -->
    <div id="outcomesContainer">
        <p class="text-muted">Select a course to view its outcomes</p>
    </div>
</div>

<!-- Update Assessment Modal -->
<div class="modal fade" id="updateAssessmentModal" tabindex="-1" aria-labelledby="updateAssessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateAssessmentModalLabel">Update Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="updateAssessmentForm">
                <div class="modal-body">
                    <input type="hidden" id="assessmentOutcomeId">
                    
                    <div class="mb-3">
                        <div class="fw-bold mb-2">Outcome Description:</div>
                        <p id="assessmentOutcomeDescription" class="text-muted"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="studentsTook" class="form-label">Students Who Took This Assessment *</label>
                        <input type="number" class="form-control" id="studentsTook" name="students_took" required min="0">
                        <small class="text-muted">How many students took THIS specific CLO assessment?</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="studentsPassed" class="form-label">Students Who Passed This Assessment *</label>
                        <input type="number" class="form-control" id="studentsPassed" name="students_passed" required min="0">
                        <small class="text-muted">How many students passed THIS specific CLO assessment?</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assessmentTool" class="form-label">Assessment Tool *</label>
                        <input type="text" class="form-control" id="assessmentTool" name="assessment_tool" required maxlength="50" placeholder="e.g., Test #3, Lab 2, Final Project">
                        <small class="text-muted">Brief description (50 characters max)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Assessment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const courseSelect = document.getElementById('courseSelect');
    const outcomesContainer = document.getElementById('outcomesContainer');
    const updateAssessmentModal = document.getElementById('updateAssessmentModal');
    const updateAssessmentForm = document.getElementById('updateAssessmentForm');
    
    // Store sections data for enrollment lookup
    let instructorSections = [];
    
    console.log('üì¢ ASSESSMENT JS: Elements found:', {
        courseSelect: !!courseSelect,
        outcomesContainer: !!outcomesContainer
    });
    
    // Load instructor's courses
    async function loadCourses() {
        console.log('üì¢ loadCourses() START');
        try {
            // Get sections for instructor
            console.log('üì¢ Fetching /api/sections...');
            const sectionsResponse = await fetch('/api/sections');
            console.log(`üì¢ /api/sections response: ${sectionsResponse.status}`);
            if (!sectionsResponse.ok) throw new Error('Failed to load sections');
            const sectionsData = await sectionsResponse.json();
            const sections = sectionsData.sections || [];
            instructorSections = sections; // Store for later use
            console.log(`üì¢ Got ${sections.length} sections`);
            if (sections.length > 0) {
                console.log(`üì¢ First section FULL:`, JSON.stringify(sections[0], null, 2));
                console.log(`üì¢ First section course_id:`, sections[0].course_id);
                console.log(`üì¢ First section offering_id:`, sections[0].offering_id);
                console.log(`üì¢ First section enrollment:`, sections[0].enrollment);
            }
            
            // Get unique course IDs from sections
            const courseIds = [...new Set(sections.map(s => s.course_id))];
            console.log(`üì¢ Unique course IDs: ${courseIds.length}`, courseIds);
            
            // Get course details
            console.log('üì¢ Fetching /api/courses...');
            const coursesResponse = await fetch('/api/courses');
            console.log(`üì¢ /api/courses response: ${coursesResponse.status}`);
            if (!coursesResponse.ok) throw new Error('Failed to load courses');
            const coursesData = await coursesResponse.json();
            const allCourses = coursesData.courses || [];
            console.log(`üì¢ Got ${allCourses.length} total courses`);
            
            // Filter to only courses instructor has sections for
            const instructorCourses = allCourses.filter(c => courseIds.includes(c.course_id));
            console.log(`üì¢ Filtered to ${instructorCourses.length} instructor courses`);
            
            // Populate dropdown with term and section info
            courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
            instructorCourses.forEach(course => {
                // Find sections for this course
                const courseSections = sections.filter(s => s.course_id === course.course_id);
                courseSections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = course.course_id;
                    const termName = section.term_name || 'Unknown Term';
                    const sectionNumber = section.section_number || '001';
                    option.textContent = `${termName} - ${course.course_number} - Section ${sectionNumber}`;
                    courseSelect.appendChild(option);
                });
            });
            console.log('üì¢ loadCourses() COMPLETE');
        } catch (error) {
            console.error('‚ùå Error loading courses:', error);
            courseSelect.innerHTML = '<option value="">Error loading courses</option>';
        }
    }
    
    // Load outcomes for selected course
    async function loadOutcomes(courseId) {
        if (!courseId) {
            outcomesContainer.innerHTML = '<p class="text-muted">Select a course to view its outcomes</p>';
            return;
        }
        
        outcomesContainer.innerHTML = '<p>Loading outcomes...</p>';
        
        try {
            const response = await fetch(`/api/courses/${courseId}/outcomes`);
            if (!response.ok) throw new Error('Failed to load outcomes');
            
            const data = await response.json();
            const outcomes = data.outcomes || [];
            
            if (outcomes.length === 0) {
                outcomesContainer.innerHTML = `
                    <div class="alert alert-info">
                        No outcomes defined for ${data.course_number} - ${data.course_title}
                    </div>
                `;
                return;
            }
            
            // Get section info for this course from instructor's sections
            const courseSections = instructorSections.filter(s => s.course_id === courseId);
            const section = courseSections.length > 0 ? courseSections[0] : null;
            
            // Get term info
            let termName = 'Unknown Term';
            if (section && section.term_name) {
                termName = section.term_name;
            } else if (section && section.term_id) {
                // Fallback: fetch term from API if needed (but should be in section data)
                termName = section.term_id;
            }
            
            // Build course header with term and section info
            const courseHeader = section 
                ? `${termName} - ${data.course_number} - Section ${section.section_number || '001'}`
                : `${data.course_number} - ${data.course_title}`;
            
            const enrollmentInfo = section && section.enrollment 
                ? `<span class="text-muted">${section.enrollment} students enrolled</span>`
                : '';
            
            // Display outcomes with update buttons
            let html = `
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white py-3">
                        <h4 class="mb-0"><i class="fas fa-graduation-cap"></i> ${courseHeader}</h4>
                        ${enrollmentInfo ? `<small>${enrollmentInfo}</small>` : ''}
                    </div>
                    <div class="card-body">
                        <h5 class="mb-3">Course Learning Outcomes</h5>
                        <p class="text-muted mb-4">Complete assessments for each learning outcome below. Click "Update Assessment" to enter student performance data.</p>
                        <div class="outcomes-list">
            `;
            
            outcomes.forEach((outcome, index) => {
                // Get assessment data (updated from CEI demo feedback)
                const studentsTook = outcome.students_took || 0;
                const studentsPassed = outcome.students_passed || 0;
                const assessmentTool = outcome.assessment_tool || '';
                const percentage = studentsTook > 0 ? Math.round((studentsPassed / studentsTook) * 100) : 0;
                
                // Get CLO status and feedback
                const status = outcome.status || 'assigned';
                const feedback = outcome.feedback_comments || '';
                
                // Determine if assessment is complete (has required new fields)
                const isComplete = studentsTook > 0 && studentsPassed >= 0 && assessmentTool;
                const isApproved = status === 'approved';
                const needsWork = status === 'approval_pending' && feedback;
                
                // Get status indicator and styling
                const statusIndicator = getStatusIndicatorHtml(status, isComplete, needsWork);
                const borderColorClass = getBorderColorClass(isApproved, needsWork, isComplete);
                const successRateColorClass = getSuccessRateColorClass(percentage);
                
                html += `
                    <div class="card mb-3 border-start border-4 ${borderColorClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <h6 class="text-primary mb-2">CLO ${index + 1}</h6>
                                    <p class="mb-2 fw-bold">${escapeHtml(outcome.description)}</p>
                                    ${statusIndicator ? `<div class="mb-2">${statusIndicator}</div>` : ''}
                                </div>
                            </div>
                            
                            ${isComplete ? `
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <div class="p-3 bg-light rounded">
                                            <small class="text-muted d-block">Students Took</small>
                                            <strong class="fs-5">${studentsTook}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 bg-light rounded">
                                            <small class="text-muted d-block">Students Passed</small>
                                            <strong class="fs-5 text-success">${studentsPassed}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 bg-light rounded">
                                            <small class="text-muted d-block">Success Rate</small>
                                            <strong class="fs-5 ${getSuccessRateColorClass(percentage)}">${percentage}%</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 bg-light rounded">
                                            <small class="text-muted d-block">Assessment Tool</small>
                                            <strong class="fs-6">${escapeHtml(assessmentTool)}</strong>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="alert alert-light mb-3">
                                    <i class="fas fa-info-circle text-muted"></i> No assessment data entered yet
                                </div>
                            `}
                            
                            ${needsWork ? `
                                <div class="alert alert-warning mt-3">
                                    <strong><i class="fas fa-exclamation-triangle"></i> Revision Requested:</strong>
                                    <p class="mb-0 mt-2">${escapeHtml(feedback)}</p>
                                </div>
                            ` : ''}
                            
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-primary update-assessment-btn" 
                                        data-outcome-id="${outcome.outcome_id}"
                                        data-description="${escapeHtml(outcome.description)}"
                                        data-students-took="${outcome.students_took || ''}"
                                        data-students-passed="${outcome.students_passed || ''}"
                                        data-assessment-tool="${escapeHtml(outcome.assessment_tool || '')}"
                                        data-status="${status}">
                                    <i class="fas fa-edit"></i> ${isComplete ? 'Update' : 'Enter'} Assessment
                                </button>
                                ${canSubmitForApproval(status) && isComplete ? `
                                    <button class="btn btn-success submit-clo-btn" 
                                            data-outcome-id="${outcome.outcome_id}"
                                            data-description="${escapeHtml(outcome.description)}">
                                        <i class="fas fa-paper-plane"></i> Submit for Approval
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            outcomesContainer.innerHTML = html;
            
            // Add click handlers for update buttons
            document.querySelectorAll('.update-assessment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openUpdateAssessmentModal(this.dataset);
                });
            });
            
            // Add click handlers for submit buttons
            document.querySelectorAll('.submit-clo-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    submitCLOForApproval(this.dataset.outcomeId, this.dataset.description);
                });
            });
            
        } catch (error) {
            console.error('Error loading outcomes:', error);
            outcomesContainer.innerHTML = '<div class="alert alert-danger">Error loading outcomes</div>';
        }
    }
    
    // Get status badge HTML
    function getStatusBadge(status) {
        const badges = {
            'unassigned': '<span class="badge bg-secondary">Unassigned</span>',
            'assigned': '<span class="badge bg-info">Assigned</span>',
            'in_progress': '<span class="badge bg-primary">In Progress</span>',
            'awaiting_approval': '<span class="badge bg-warning">Awaiting Approval</span>',
            'approval_pending': '<span class="badge bg-danger">Needs Rework</span>',
            'approved': '<span class="badge bg-success">‚úì Approved</span>'
        };
        return badges[status] || '';
    }
    
    // Check if CLO can be submitted
    function canSubmitForApproval(status) {
        return status === 'in_progress' || status === 'approval_pending';
    }
    
    // Submit CLO for approval
    async function submitCLOForApproval(outcomeId, description) {
        if (!confirm(`Submit "${description}" for approval?\n\nOnce submitted, it will be reviewed by an administrator.`)) {
            return;
        }
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            
            const response = await fetch(`/api/outcomes/${outcomeId}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to submit for approval');
            }
            
            alert('CLO submitted for approval successfully!');
            
            // Reload outcomes for current course
            const currentCourseId = courseSelect.value;
            if (currentCourseId) {
                await loadOutcomes(currentCourseId);
            }
            
        } catch (error) {
            console.error('Error submitting for approval:', error);
            alert('Failed to submit for approval: ' + error.message);
        }
    }
    
    // Open update assessment modal
    function openUpdateAssessmentModal(outcomeData) {
        document.getElementById('assessmentOutcomeId').value = outcomeData.outcomeId;
        document.getElementById('assessmentOutcomeDescription').textContent = outcomeData.description;
        
        // Populate with existing values (updated field names from CEI demo feedback)
        document.getElementById('studentsTook').value = outcomeData.studentsTook || '';
        document.getElementById('studentsPassed').value = outcomeData.studentsPassed || '';
        document.getElementById('assessmentTool').value = outcomeData.assessmentTool || '';
        
        const modal = new bootstrap.Modal(updateAssessmentModal);
        modal.show();
    }
    
    // Track if user has started editing (for auto-marking in_progress)
    let hasEdited = false;
    let autoMarkTriggered = false;
    
    // Auto-track editing on form fields (updated field names from CEI demo feedback)
    ['studentsTook', 'studentsPassed', 'assessmentTool'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                hasEdited = true;
                
                // Auto-mark as in_progress on first edit (debounced)
                if (!autoMarkTriggered) {
                    autoMarkTriggered = true;
                    const outcomeId = document.getElementById('assessmentOutcomeId').value;
                    const status = document.querySelector(`.update-assessment-btn[data-outcome-id="${outcomeId}"]`)?.dataset?.status;
                    
                    // Only auto-mark if status is assigned or approval_pending
                    if (status === 'assigned' || status === 'approval_pending') {
                        setTimeout(() => autoMarkInProgress(outcomeId), 1000);
                    }
                }
            });
        }
    });
    
    // Auto-mark CLO as in_progress
    async function autoMarkInProgress(outcomeId) {
        try {
            // This will be called silently - no need to show success/error to user
            // Note: The backend update_course_outcome will handle auto-marking
            // We could add a dedicated endpoint, but for now the assessment update will trigger it
            console.log(`Auto-marking outcome ${outcomeId} as in_progress`);
        } catch (error) {
            console.error('Error auto-marking in progress:', error);
            // Silent fail - not critical
        }
    }
    
    // Handle assessment form submission
    updateAssessmentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const outcomeId = document.getElementById('assessmentOutcomeId').value;
        const studentsTook = parseInt(document.getElementById('studentsTook').value);
        const studentsPassed = parseInt(document.getElementById('studentsPassed').value);
        const assessmentTool = document.getElementById('assessmentTool').value.trim();
        
        // Validation (updated from CEI demo feedback)
        if (studentsPassed > studentsTook) {
            alert('Students who passed cannot exceed students who took the assessment');
            return;
        }
        
        if (!assessmentTool || assessmentTool.length === 0) {
            alert('Assessment tool is required');
            return;
        }
        
        if (assessmentTool.length > 50) {
            alert('Assessment tool must be 50 characters or less');
            return;
        }
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            
            const response = await fetch(`/api/outcomes/${outcomeId}/assessment`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    students_took: studentsTook,
                    students_passed: studentsPassed,
                    assessment_tool: assessmentTool
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update assessment');
            }
            
            // Close modal and reload outcomes
            const modal = bootstrap.Modal.getInstance(updateAssessmentModal);
            modal.hide();
            
            // Reset tracking state
            hasEdited = false;
            autoMarkTriggered = false;
            
            alert('Assessment updated successfully!');
            
            // Reload outcomes for current course
            const currentCourseId = courseSelect.value;
            if (currentCourseId) {
                await loadOutcomes(currentCourseId);
            }
            
        } catch (error) {
            console.error('Error updating assessment:', error);
            alert('Failed to update assessment: ' + error.message);
        }
    });
    
    // Course selection handler
    courseSelect.addEventListener('change', function() {
        loadOutcomes(this.value);
        loadCourseLevelData(this.value); // NEW: Load course-level assessment data
    });
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Helper function to get status indicator HTML
    function getStatusIndicatorHtml(status, isComplete, needsWork) {
        if (status === 'approved') {
            return '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Approved</span>';
        }
        if (status === 'awaiting_approval') {
            return '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending Review</span>';
        }
        if (needsWork) {
            return '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Needs Revision</span>';
        }
        if (isComplete) {
            return '<span class="badge bg-info"><i class="fas fa-edit"></i> In Progress</span>';
        }
        return '';
    }
    
    // Helper function to get border color class
    function getBorderColorClass(isApproved, needsWork, isComplete) {
        if (isApproved) return 'border-success';
        if (needsWork) return 'border-danger';
        if (isComplete) return 'border-info';
        return 'border-secondary';
    }
    
    // Helper function to get success rate color class
    function getSuccessRateColorClass(percentage) {
        if (percentage >= 80) return 'text-success';
        if (percentage >= 60) return 'text-warning';
        return 'text-danger';
    }
    
    // Course-Level Assessment Section Handlers (NEW from CEI demo feedback)
    const courseLevelSection = document.getElementById('courseLevelSection');
    const cannotReconcileCheckbox = document.getElementById('cannotReconcile');
    const reconciliationNoteContainer = document.getElementById('reconciliationNoteContainer');
    const saveCourseDataBtn = document.getElementById('saveCourseData');
    
    // Toggle reconciliation note visibility
    if (cannotReconcileCheckbox) {
        cannotReconcileCheckbox.addEventListener('change', function() {
            reconciliationNoteContainer.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('reconciliationNote').value = '';
            }
        });
    }
    
    // Load course-level data when course is selected
    async function loadCourseLevelData(courseId) {
        try {
            // For now, use section data - in full implementation, this would be course-level
            const section = instructorSections.find(s => s.course_id === courseId);
            if (section) {
                // Populate read-only enrollment fields
                document.getElementById('courseEnrollment').value = section.enrollment || 'Not set';
                document.getElementById('courseWithdrawals').value = section.withdrawals || 0;
                
                // Format and display due date (added from CEI demo feedback)
                if (section.due_date) {
                    const dueDate = new Date(section.due_date);
                    document.getElementById('courseDueDate').value = dueDate.toLocaleDateString();
                } else {
                    document.getElementById('courseDueDate').value = 'Not set';
                }
                
                // Populate instructor input fields (if they exist)
                document.getElementById('courseStudentsPassed').value = section.students_passed || '';
                document.getElementById('courseStudentsDFIC').value = section.students_dfic || '';
                document.getElementById('cannotReconcile').checked = section.cannot_reconcile || false;
                document.getElementById('reconciliationNote').value = section.reconciliation_note || '';
                
                // Show/hide reconciliation note based on checkbox
                reconciliationNoteContainer.style.display = section.cannot_reconcile ? 'block' : 'none';
                
                // Populate narratives
                document.getElementById('narrativeCelebrations').value = section.narrative_celebrations || '';
                document.getElementById('narrativeChallenges').value = section.narrative_challenges || '';
                document.getElementById('narrativeChanges').value = section.narrative_changes || '';
                
                // Show the section
                courseLevelSection.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading course-level data:', error);
        }
    }
    
    // Save course-level data
    if (saveCourseDataBtn) {
        saveCourseDataBtn.addEventListener('click', async function() {
            const courseId = courseSelect.value;
            if (!courseId) {
                alert('Please select a course first');
                return;
            }
            
            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                const section = instructorSections.find(s => s.course_id === courseId);
                
                if (!section) {
                    alert('No section found for this course');
                    return;
                }
                
                const data = {
                    students_passed: parseInt(document.getElementById('courseStudentsPassed').value) || null,
                    students_dfic: parseInt(document.getElementById('courseStudentsDFIC').value) || null,
                    cannot_reconcile: document.getElementById('cannotReconcile').checked,
                    reconciliation_note: document.getElementById('reconciliationNote').value.trim() || null,
                    narrative_celebrations: document.getElementById('narrativeCelebrations').value.trim() || null,
                    narrative_challenges: document.getElementById('narrativeChallenges').value.trim() || null,
                    narrative_changes: document.getElementById('narrativeChanges').value.trim() || null
                };
                
                const response = await fetch(`/api/sections/${section.section_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save course data');
                }
                
                alert('Course data saved successfully!');
                
            } catch (error) {
                console.error('Error saving course data:', error);
                alert('Failed to save course data: ' + error.message);
            }
        });
    }
    
    // Initialize - call async function
    loadCourses().then(() => {
        // Auto-select course if provided in URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const courseParam = urlParams.get('course');
        if (courseParam && courseSelect) {
            courseSelect.value = courseParam;
            loadOutcomes(courseParam);
            loadCourseLevelData(courseParam); // NEW: Load course-level data on auto-select
        }
    }).catch(err => console.error('Failed to load courses:', err));
});
</script>
{% endblock %}

