{% extends "dashboard/base_dashboard.html" %}

{% block title %}Site Administrator Dashboard - MockU Course Admin{% endblock %}

{% block nav_items %}
<a class="nav-link" href="/api/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
<button class="nav-link btn btn-link" type="button" onclick="showInstitutions()"><i class="fas fa-university me-1"></i>Institutions</button>
<button class="nav-link btn btn-link" type="button" onclick="showUsers()"><i class="fas fa-users me-1"></i>Users</button>
<button class="nav-link btn btn-link" type="button" onclick="showSystemSettings()"><i class="fas fa-cogs me-1"></i>System</button>
{% endblock %}

{% block page_title %}Site Administrator Dashboard{% endblock %}
{% block page_subtitle %}Manage institutions, users, and system settings{% endblock %}

{% block content %}
<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-primary">Institutions</h5>
                        <h3 class="mb-0">
                            <span class="visually-hidden">Institution count: </span>
                            <output id="institutionCount" aria-live="polite">
                                <span class="spinner-border spinner-border-sm" aria-label="Loading"></span>
                            </output>
                        </h3>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-university fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-success">Total Users</h5>
                        <h3 class="mb-0">
                            <span class="visually-hidden">User count: </span>
                            <output id="userCount" aria-live="polite">
                                <span class="spinner-border spinner-border-sm" aria-label="Loading"></span>
                            </output>
                        </h3>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-warning">Programs</h5>
                        <h3 class="mb-0">
                            <span class="visually-hidden">Program count: </span>
                            <output id="programCount" aria-live="polite">
                                <span class="spinner-border spinner-border-sm" aria-label="Loading"></span>
                            </output>
                        </h3>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-graduation-cap fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-info">Active Courses</h5>
                        <h3 class="mb-0">
                            <span class="visually-hidden">Course count: </span>
                            <output id="courseCount" aria-live="polite">
                                <span class="spinner-border spinner-border-sm" aria-label="Loading"></span>
                            </output>
                        </h3>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Management Sections -->
<div class="row">
    <!-- Institution Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-university me-2"></i>Institution Management</h5>
                <button class="btn btn-primary btn-sm" onclick="createInstitution()">
                    <i class="fas fa-plus me-1"></i>Add Institution
                </button>
            </div>
            <div class="card-body">
                <div id="institutionsList">
                    <div class="text-center py-3">
                        <output class="spinner-border"></output>
                        <p class="mt-2 text-muted">Loading institutions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>User Management</h5>
                <button class="btn btn-success btn-sm" onclick="inviteUser()">
                    <i class="fas fa-user-plus me-1"></i>Add User
                </button>
            </div>
            <div class="card-body">
                <div id="usersList">
                    <div class="text-center py-3">
                        <output class="spinner-border"></output>
                        <p class="mt-2 text-muted">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Overview -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>System Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Recent Activity</h6>
                        <div id="recentActivity">
                            <div class="text-center py-3">
                                <output class="spinner-border spinner-border-sm"></output>
                                <small class="text-muted ms-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>System Health</h6>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2">Online</span>
                            <small class="text-muted">All systems operational</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Quick Actions</h6>
                        <div class="btn-group-vertical d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="exportSystemData()">
                                <i class="fas fa-download me-1"></i>Export Data
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showSystemLogs()">
                                <i class="fas fa-list me-1"></i>View Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Institution Modal -->
<div class="modal fade" id="createInstitutionModal" tabindex="-1" aria-labelledby="createInstitutionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createInstitutionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInstitutionModalLabel">Create New Institution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="institutionName" class="form-label">Institution Name *</label>
                        <input type="text" class="form-control" id="institutionName" required>
                    </div>
                    <div class="mb-3">
                        <label for="institutionShortName" class="form-label">Short Name *</label>
                        <input type="text" class="form-control" id="institutionShortName" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="institutionActive" checked>
                        <label class="form-check-label" for="institutionActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Institution</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createUserForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userFirstName" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="userFirstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userLastName" class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="userLastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role *</label>
                        <select class="form-control" id="userRole" required>
                            <option value="">Select role...</option>
                            <option value="site_admin">Site Admin</option>
                            <option value="institution_admin">Institution Admin</option>
                            <option value="program_admin">Program Admin</option>
                            <option value="instructor">Instructor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userInstitutionId" class="form-label">Institution *</label>
                        <select class="form-control" id="userInstitutionId" required>
                            <option value="">Select institution...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Site Admin Dashboard JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        loadSiteAdminData();
    });

    async function loadSiteAdminData() {
        try {
            // Load stats
            await Promise.all([
                loadInstitutionCount(),
                loadUserCount(), 
                loadProgramCount(),
                loadCourseCount(),
                loadInstitutionsList(),
                loadUsersList()
            ]);
        } catch (error) {
            console.error('Error loading site admin data:', error);
        }
    }

    async function loadInstitutionCount() {
        try {
            const response = await fetch('/api/institutions');
            const data = await response.json();
            document.getElementById('institutionCount').textContent = data.institutions ? data.institutions.length : 0;
        } catch (error) {
            document.getElementById('institutionCount').textContent = 'Error';
        }
    }

    async function loadUserCount() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            document.getElementById('userCount').textContent = data.count || 0;
        } catch (error) {
            document.getElementById('userCount').textContent = 'Error';
        }
    }

    async function loadProgramCount() {
        try {
            const response = await fetch('/api/programs');
            const data = await response.json();
            document.getElementById('programCount').textContent = data.count || 0;
        } catch (error) {
            document.getElementById('programCount').textContent = 'Error';
        }
    }

    async function loadCourseCount() {
        try {
            const response = await fetch('/api/courses');
            const data = await response.json();
            document.getElementById('courseCount').textContent = data.count || 0;
        } catch (error) {
            document.getElementById('courseCount').textContent = 'Error';
        }
    }

    async function loadInstitutionsList() {
        try {
            const response = await fetch('/api/institutions');
            const data = await response.json();
            
            const container = document.getElementById('institutionsList');
            if (data.success && data.institutions) {
                container.innerHTML = data.institutions.map(inst => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${inst.name}</strong>
                            <br><small class="text-muted">${inst.short_name}</small>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="editInstitution('${inst.institution_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">No institutions found</p>';
            }
        } catch (error) {
            document.getElementById('institutionsList').innerHTML = '<p class="text-danger">Error loading institutions</p>';
        }
    }

    async function loadUsersList() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            const container = document.getElementById('usersList');
            if (data.success && data.users) {
                container.innerHTML = data.users.slice(0, 5).map(user => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${user.first_name} ${user.last_name}</strong>
                            <br><small class="text-muted">${user.email}</small>
                        </div>
                        <span class="badge bg-secondary">${user.role.replace('_', ' ')}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">No users found</p>';
            }
        } catch (error) {
            document.getElementById('usersList').innerHTML = '<p class="text-danger">Error loading users</p>';
        }
    }

    // Action functions
    function createInstitution() {
        const modal = new bootstrap.Modal(document.getElementById('createInstitutionModal'));
        modal.show();
    }

    function editInstitution(id) {
        alert(`Edit Institution ${id} feature coming soon!`);
    }

    function inviteUser() {
        const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
        // Load institutions for dropdown
        loadInstitutionsForUserForm();
        modal.show();
    }

    async function loadInstitutionsForUserForm() {
        try {
            const response = await fetch('/api/institutions');
            const data = await response.json();
            const select = document.getElementById('userInstitutionId');
            
            if (data.success && data.institutions) {
                select.innerHTML = '<option value="">Select institution...</option>' +
                    data.institutions.map(inst => 
                        `<option value="${inst.institution_id}">${inst.name}</option>`
                    ).join('');
            }
        } catch (error) {
            console.error('Error loading institutions:', error);
        }
    }

    function exportSystemData() {
        alert('Export System Data feature coming soon!');
    }

    function showSystemLogs() {
        alert('System Logs feature coming soon!');
    }

    function showInstitutions() {
        alert('Institutions management feature coming soon!');
    }

    function showUsers() {
        alert('Users management feature coming soon!');
    }

    function showSystemSettings() {
        alert('System Settings feature coming soon!');
    }

    // Form submission handlers
    document.getElementById('createInstitutionForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('institutionName').value;
        const shortName = document.getElementById('institutionShortName').value;
        const active = document.getElementById('institutionActive').checked;
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch('/api/institutions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ name, short_name: shortName, active })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const modalElement = document.getElementById('createInstitutionModal');
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();
                this.reset();
                await loadSiteAdminData();
                alert('Institution created successfully');
            } else {
                alert('Error creating institution: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error creating institution:', error);
            alert('Error creating institution. Please try again.');
        }
    });

    document.getElementById('createUserForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const firstName = document.getElementById('userFirstName').value;
        const lastName = document.getElementById('userLastName').value;
        const email = document.getElementById('userEmail').value;
        const role = document.getElementById('userRole').value;
        const institutionId = document.getElementById('userInstitutionId').value;
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    first_name: firstName,
                    last_name: lastName,
                    email,
                    role,
                    institution_id: institutionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const modalElement = document.getElementById('createUserModal');
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();
                this.reset();
                await loadSiteAdminData();
                alert('User created successfully');
            } else {
                alert('Error creating user: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error creating user:', error);
            alert('Error creating user. Please try again.');
        }
    });
</script>
{% endblock %}
