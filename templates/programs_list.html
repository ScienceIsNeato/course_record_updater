{% extends "dashboard/base_dashboard.html" %} {% block title %}Programs -
LoopCloser{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='panels.css') }}" />
{% endblock %} {% block nav_items %}
<a class="nav-link" href="/dashboard"
  ><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a
>
<a class="nav-link active" href="/programs"
  ><i class="fas fa-graduation-cap me-1"></i>Programs</a
>
<a class="nav-link" href="/courses"><i class="fas fa-book me-1"></i>Courses</a>
<a class="nav-link" href="/users"><i class="fas fa-users me-1"></i>Users</a>
<a class="nav-link" href="/sections"
  ><i class="fas fa-clipboard-list me-1"></i>Sections</a
>
{% endblock %} {% block page_title %}Programs{% endblock %} {% block
page_subtitle %}Browse all academic programs at your institution{% endblock %}
{% block content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">All Programs</h5>
      <button class="btn btn-sm btn-outline-primary" onclick="loadPrograms()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>

    <div id="programsTableContainer">
      <output
        class="d-flex justify-content-center align-items-center"
        style="min-height: 200px"
        aria-live="polite"
      >
        <div class="spinner-border" aria-hidden="true">
          <span class="visually-hidden">Loading programs...</span>
        </div>
      </output>
    </div>
  </div>
</div>

<!-- Edit Program Modal -->
<div
  class="modal fade"
  id="editProgramModal"
  tabindex="-1"
  aria-labelledby="editProgramModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProgramModalLabel">Edit Program</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form id="editProgramForm">
        <input type="hidden" id="editProgramId" />
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editProgramName" class="form-label"
                >Program Name *</label
              >
              <input
                type="text"
                class="form-control"
                id="editProgramName"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editProgramShortName" class="form-label"
                >Short Name (Code) *</label
              >
              <input
                type="text"
                class="form-control"
                id="editProgramShortName"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label for="editProgramDescription" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="editProgramDescription"
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Save Changes</span>
            <span class="btn-spinner d-none">
              <span
                class="spinner-border spinner-border-sm"
                aria-hidden="true"
              ></span>
              Saving...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Load programs on page load
  document.addEventListener("DOMContentLoaded", function () {
    loadPrograms();

    // Handle edit program form submission
    const editForm = document.getElementById("editProgramForm");
    if (editForm) {
      editForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const programId = document.getElementById("editProgramId").value;
        const programName = document.getElementById("editProgramName").value;
        const shortName = document.getElementById("editProgramShortName").value;
        const description = document.getElementById(
          "editProgramDescription",
        ).value;

        // Show loading state
        const submitBtn = editForm.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector(".btn-text");
        const btnSpinner = submitBtn.querySelector(".btn-spinner");
        btnText.classList.add("d-none");
        btnSpinner.classList.remove("d-none");
        submitBtn.disabled = true;

        try {
          const csrfToken = document.querySelector(
            'meta[name="csrf-token"]',
          )?.content;
          const response = await fetch(`/api/programs/${programId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
              name: programName,
              short_name: shortName,
              description: description,
            }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to update program");
          }

          // Close modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("editProgramModal"),
          );
          modal.hide();

          // Reload programs to show updated data
          await loadPrograms();

          // Show success message
          alert("✅ Program updated successfully!");
        } catch (error) {
          console.error("Error updating program:", error);
          alert("❌ Failed to update program: " + error.message);
        } finally {
          // Reset button state
          btnText.classList.remove("d-none");
          btnSpinner.classList.add("d-none");
          submitBtn.disabled = false;
        }
      });
    }
  });

  async function loadPrograms() {
    const container = document.getElementById("programsTableContainer");
    container.innerHTML = `
        <output class="d-flex justify-content-center align-items-center" style="min-height: 200px;" aria-live="polite">
            <div class="spinner-border" aria-hidden="true">
                <span class="visually-hidden">Loading programs...</span>
            </div>
        </output>
    `;

    try {
      const response = await fetch("/api/programs", {
        headers: {
          Accept: "application/json",
        },
      });

      if (!response.ok) {
        throw new Error("Failed to load programs");
      }

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || "Failed to load programs");
      }

      const programs = data.programs || [];

      if (programs.length === 0) {
        container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No programs found. Import program data to get started.
                </div>
            `;
        return;
      }

      // Build table
      let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Program Name</th>
                            <th>Code</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

      programs.forEach((program) => {
        html += `
                <tr>
                    <td><strong>${escapeHtml(program.name || "-")}</strong></td>
                    <td>${escapeHtml(program.short_name || "-")}</td>
                    <td>${escapeHtml(program.description || "-")}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick='openEditProgramModal("${program.program_id}", ${JSON.stringify(program).replaceAll("'", "&apos;")})'>
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                </tr>
            `;
      });

      html += `
                    </tbody>
                </table>
            </div>
        `;

      container.innerHTML = html;
    } catch (error) {
      console.error("Error loading programs:", error);
      container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading programs: ${escapeHtml(error.message)}
            </div>
        `;
    }
  }

  function openEditProgramModal(programId, programData) {
    document.getElementById("editProgramId").value = programId;
    document.getElementById("editProgramName").value = programData.name || "";
    document.getElementById("editProgramShortName").value =
      programData.short_name || "";
    document.getElementById("editProgramDescription").value =
      programData.description || "";

    const modal = new bootstrap.Modal(
      document.getElementById("editProgramModal"),
    );
    modal.show();
  }

  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }
</script>
{% endblock %}
