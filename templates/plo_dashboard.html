{% extends "dashboard/base_dashboard.html" %}

{% block title %}PLO Dashboard - Loopcloser{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='panels.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='plo_dashboard.css') }}">
{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Program Learning Outcomes</h1>
            <p class="text-muted">Review PLO-to-CLO mappings and assessment data across programs.
                Drill down from programs to individual section outcomes.</p>
        </div>
        <div>
            <button class="btn btn-success" id="createPloBtn">
                <i class="fas fa-plus me-1"></i> New PLO
            </button>
        </div>
    </div>

    <!-- Summary Stats Row -->
    <div class="row mb-4" id="ploSummaryStats">
        <div class="col">
            <div class="card" style="border-color: #0d6efd; border-width: 2px;">
                <div class="card-body text-center py-2">
                    <h4 class="mb-0" id="statPrograms" style="color: #0d6efd;">-</h4>
                    <p class="mb-0 small" style="color: #0d6efd;">Programs</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="border-color: #6f42c1; border-width: 2px;">
                <div class="card-body text-center py-2">
                    <h4 class="mb-0" id="statPlos" style="color: #6f42c1;">-</h4>
                    <p class="mb-0 small" style="color: #6f42c1;">PLOs</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="border-color: #20c997; border-width: 2px;">
                <div class="card-body text-center py-2">
                    <h4 class="mb-0" id="statMappedClos" style="color: #20c997;">-</h4>
                    <p class="mb-0 small" style="color: #20c997;">Mapped CLOs</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="border-color: #198754; border-width: 2px;">
                <div class="card-body text-center py-2">
                    <h4 class="mb-0" id="statWithData" style="color: #198754;">-</h4>
                    <p class="mb-0 small" style="color: #198754;">With Data</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="border-color: #dc3545; border-width: 2px;">
                <div class="card-body text-center py-2">
                    <h4 class="mb-0" id="statMissingData" style="color: #dc3545;">-</h4>
                    <p class="mb-0 small" style="color: #dc3545;">Missing Data</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters: Term + Program -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="ploTermFilter" class="form-label mb-1">Term</label>
                    <select class="form-select form-select-sm" id="ploTermFilter">
                        <option value="">Loading terms...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="ploProgramFilter" class="form-label mb-1">Program</label>
                    <select class="form-select form-select-sm" id="ploProgramFilter">
                        <option value="">All Programs</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="ploDisplayMode" class="form-label mb-1">
                        Assessment Display
                        <i class="fas fa-info-circle text-muted"
                           title="How pass/fail results appear on each node. Controls binary (S/U), percentage, or both."></i>
                    </label>
                    <select class="form-select form-select-sm" id="ploDisplayMode">
                        <option value="both">Both (S (78%) / U (22%))</option>
                        <option value="percentage">Percentage (78%)</option>
                        <option value="binary">Binary (S / U)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Drill-down Tree Container -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">PLO Tree</span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="expandAllBtn">
                    <i class="fas fa-angle-double-down"></i> Expand All
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="collapseAllBtn">
                    <i class="fas fa-angle-double-up"></i> Collapse All
                </button>
                <button class="btn btn-sm btn-outline-primary" id="mapCloBtn">
                    <i class="fas fa-link"></i> Map CLO to PLO
                </button>
                <button class="btn btn-sm btn-outline-primary" id="ploRefreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="ploTreeContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"><span class="visually-hidden">Loading...</span></div>
                    <p class="text-muted mt-2">Loading PLO data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit PLO Modal -->
<div class="modal fade" id="ploModal" tabindex="-1" aria-labelledby="ploModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ploModalLabel">New Program Outcome</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="ploForm">
                <div class="modal-body">
                    <input type="hidden" id="ploModalId">
                    <div class="mb-3">
                        <label for="ploModalProgram" class="form-label">Program *</label>
                        <select class="form-select" id="ploModalProgram" required>
                            <option value="">Select a program…</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ploModalDescription" class="form-label">Description *</label>
                        <textarea class="form-control" id="ploModalDescription" rows="4" required
                                  placeholder="Students will be able to…"></textarea>
                    </div>
                    <div id="ploModalAlert" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="ploModalSaveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Map CLO to PLO Modal -->
<div class="modal fade" id="mapCloModal" tabindex="-1" aria-labelledby="mapCloModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapCloModalLabel">Map CLO to PLO</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="mapCloForm">
                <div class="modal-body">
                    <p class="text-muted small">
                        Select a Program Learning Outcome and a Course Learning Outcome to link them.
                        The mapping will be added to the current draft. Publish the draft when you're
                        ready to make it the version of record.
                    </p>
                    <div class="mb-3">
                        <label for="mapCloModalProgram" class="form-label">Program *</label>
                        <select class="form-select" id="mapCloModalProgram" required>
                            <option value="">Select a program…</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mapCloModalPlo" class="form-label">Program Outcome *</label>
                        <select class="form-select" id="mapCloModalPlo" required>
                            <option value="">Select a PLO…</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mapCloModalClo" class="form-label">Course Outcome *</label>
                        <select class="form-select" id="mapCloModalClo" required>
                            <option value="">Select a CLO…</option>
                        </select>
                        <small class="text-muted">Only unmapped CLOs from this program's courses are shown.</small>
                    </div>
                    <div id="mapCloModalAlert" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-success" id="mapCloPublishBtn">
                        <i class="fas fa-check-double"></i> Publish Draft
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-link"></i> Add Mapping
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='plo_dashboard.js') }}"></script>
{% endblock %}
