{% extends "dashboard/base_dashboard.html" %}

{% block title %}Instructor Dashboard - CEI Course Admin{% endblock %}

{% block nav_items %}
<a class="nav-link" href="/api/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
<a class="nav-link" href="#" onclick="showMySections()"><i class="fas fa-list me-1"></i>My Sections</a>
<a class="nav-link" href="#" onclick="showMyCourses()"><i class="fas fa-book me-1"></i>My Courses</a>
<a class="nav-link" href="#" onclick="showAssessments()"><i class="fas fa-chart-line me-1"></i>Assessments</a>
{% endblock %}

{% block page_title %}Instructor Dashboard{% endblock %}
{% block page_subtitle %}Manage your sections, courses, and assessments{% endblock %}

{% block content %}
<!-- Instructor Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-info mb-1">{{ user.first_name }} {{ user.last_name }}</h5>
                        <p class="text-muted mb-0">{{ user.institution_name or 'Institution' }} • {{ user.program_names[0] if user.program_names else 'Program' }} • Instructor</p>
                    </div>
                    <button class="btn btn-outline-info" onclick="editProfile()">
                        <i class="fas fa-user-edit me-1"></i>Edit Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-primary">My Sections</h5>
                        <h3 class="mb-0" id="mySectionCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </h3>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-success">Active Courses</h5>
                        <h3 class="mb-0" id="myCourseCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </h3>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-warning">Pending Assessments</h5>
                        <h3 class="mb-0" id="pendingAssessmentCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </h3>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-secondary">Current Term</h5>
                        <h3 class="mb-0" id="currentTerm">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </h3>
                    </div>
                    <div class="text-secondary">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- My Sections -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>My Current Sections</h5>
                <div>
                    <select class="form-select form-select-sm" id="termFilter" onchange="filterMySections()" style="width: auto; display: inline-block;">
                        <option value="">All Terms</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="mySectionsList">
                    <div class="text-center py-3">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2 text-muted">Loading your sections...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions and Recent Activity -->
<div class="row">
    <!-- Quick Actions -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="submitAssessment()">
                        <i class="fas fa-chart-line me-1"></i>Submit Assessment
                    </button>
                    <button class="btn btn-success" onclick="viewMyCourses()">
                        <i class="fas fa-book me-1"></i>View My Courses
                    </button>
                    <button class="btn btn-info" onclick="exportMyData()">
                        <i class="fas fa-download me-1"></i>Export My Data
                    </button>
                    <button class="btn btn-outline-secondary" onclick="requestSupport()">
                        <i class="fas fa-question-circle me-1"></i>Request Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Status -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Assessment Status</h5>
            </div>
            <div class="card-body">
                <div id="assessmentStatus">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 text-muted">Loading assessment status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Deadlines -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Deadlines</h5>
            </div>
            <div class="card-body">
                <div id="upcomingDeadlines">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 text-muted">Loading deadlines...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Details -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>My Courses</h5>
            </div>
            <div class="card-body">
                <div id="myCoursesList">
                    <div class="text-center py-3">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2 text-muted">Loading your courses...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Instructor Dashboard JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        loadInstructorData();
    });

    async function loadInstructorData() {
        try {
            await Promise.all([
                loadMySectionCount(),
                loadMyCourseCount(),
                loadPendingAssessmentCount(),
                loadCurrentTerm(),
                loadMySectionsList(),
                loadMyCoursesList(),
                loadAssessmentStatus(),
                loadUpcomingDeadlines(),
                loadTermFilter()
            ]);
        } catch (error) {
            console.error('Error loading instructor data:', error);
        }
    }

    async function loadMySectionCount() {
        try {
            const response = await fetch(`/api/sections?instructor_id=${window.currentUser.id}`);
            const data = await response.json();
            document.getElementById('mySectionCount').textContent = data.count || 0;
        } catch (error) {
            document.getElementById('mySectionCount').textContent = 'Error';
        }
    }

    async function loadMyCourseCount() {
        try {
            // This would need to be filtered by instructor's courses
            const response = await fetch('/api/courses');
            const data = await response.json();
            // For now, show all courses - this should be filtered by instructor
            document.getElementById('myCourseCount').textContent = data.count || 0;
        } catch (error) {
            document.getElementById('myCourseCount').textContent = 'Error';
        }
    }

    async function loadPendingAssessmentCount() {
        try {
            // This would be a new API endpoint for instructor's pending assessments
            document.getElementById('pendingAssessmentCount').textContent = '3'; // Placeholder
        } catch (error) {
            document.getElementById('pendingAssessmentCount').textContent = 'Error';
        }
    }

    async function loadCurrentTerm() {
        try {
            const response = await fetch('/api/terms');
            const data = await response.json();
            if (data.success && data.terms && data.terms.length > 0) {
                const currentTerm = data.terms[0]; // Assuming first is current
                document.getElementById('currentTerm').textContent = currentTerm.name || 'N/A';
            } else {
                document.getElementById('currentTerm').textContent = 'N/A';
            }
        } catch (error) {
            document.getElementById('currentTerm').textContent = 'Error';
        }
    }

    async function loadMySectionsList() {
        try {
            const response = await fetch(`/api/sections?instructor_id=${window.currentUser.id}`);
            const data = await response.json();
            
            const container = document.getElementById('mySectionsList');
            if (data.success && data.sections && data.sections.length > 0) {
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Section</th>
                                    <th>Term</th>
                                    <th>Status</th>
                                    <th>Students</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.sections.map(section => `
                                    <tr>
                                        <td>
                                            <strong>${section.course_number || 'N/A'}</strong>
                                            <br><small class="text-muted">${section.course_name || ''}</small>
                                        </td>
                                        <td>${section.section_number || 'N/A'}</td>
                                        <td>${section.term_name || 'N/A'}</td>
                                        <td>
                                            <span class="badge bg-${getStatusColor(section.status)}">${section.status || 'N/A'}</span>
                                        </td>
                                        <td>${section.student_count || 0}</td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm me-1" onclick="viewSection('${section.section_id}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="manageSection('${section.section_id}')">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-muted">No sections assigned to you yet.</p>';
            }
        } catch (error) {
            document.getElementById('mySectionsList').innerHTML = '<p class="text-danger">Error loading your sections</p>';
        }
    }

    async function loadMyCoursesList() {
        try {
            // This should be filtered by instructor's courses
            const response = await fetch('/api/courses');
            const data = await response.json();
            
            const container = document.getElementById('myCoursesList');
            if (data.success && data.courses) {
                // Filter courses that instructor teaches (placeholder logic)
                const myCourses = data.courses.slice(0, 3); // Placeholder
                container.innerHTML = myCourses.map(course => `
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6 class="mb-1">${course.course_number} - ${course.name}</h6>
                            <p class="text-muted mb-1">${course.description || 'No description available'}</p>
                            <small class="text-muted">${course.credit_hours || 0} credit hours</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="viewCourse('${course.course_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="manageCourse('${course.course_id}')">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                        </div>
                    </div>
                    <hr>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">No courses assigned to you yet.</p>';
            }
        } catch (error) {
            document.getElementById('myCoursesList').innerHTML = '<p class="text-danger">Error loading your courses</p>';
        }
    }

    async function loadAssessmentStatus() {
        try {
            // Placeholder assessment status
            const container = document.getElementById('assessmentStatus');
            container.innerHTML = `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Completed</span>
                        <span class="text-success">15</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: 75%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>In Progress</span>
                        <span class="text-warning">3</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: 15%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Pending</span>
                        <span class="text-danger">2</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: 10%"></div>
                    </div>
                </div>
            `;
        } catch (error) {
            document.getElementById('assessmentStatus').innerHTML = '<p class="text-danger">Error loading assessment status</p>';
        }
    }

    async function loadUpcomingDeadlines() {
        try {
            // Placeholder deadlines
            const container = document.getElementById('upcomingDeadlines');
            container.innerHTML = `
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-1">Mid-term Assessment</h6>
                                <small class="text-muted">BIOL 101 - Section A</small>
                            </div>
                            <small class="text-warning">3 days</small>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-1">Final Assessment</h6>
                                <small class="text-muted">CHEM 201 - Section B</small>
                            </div>
                            <small class="text-danger">1 week</small>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            document.getElementById('upcomingDeadlines').innerHTML = '<p class="text-danger">Error loading deadlines</p>';
        }
    }

    async function loadTermFilter() {
        try {
            const response = await fetch('/api/terms');
            const data = await response.json();
            if (data.success && data.terms) {
                const termFilter = document.getElementById('termFilter');
                data.terms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term.term_id;
                    option.textContent = term.name;
                    termFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading term filter:', error);
        }
    }

    function getStatusColor(status) {
        switch (status) {
            case 'assigned': return 'warning';
            case 'in_progress': return 'primary';
            case 'completed': return 'success';
            default: return 'secondary';
        }
    }

    function filterMySections() {
        // Reload sections with filter
        loadMySectionsList();
    }

    // Action functions
    function submitAssessment() {
        alert('Submit Assessment feature coming soon!');
    }

    function viewMyCourses() {
        alert('View My Courses feature coming soon!');
    }

    function exportMyData() {
        alert('Export My Data feature coming soon!');
    }

    function requestSupport() {
        alert('Request Support feature coming soon!');
    }

    function viewSection(id) {
        alert(`View Section ${id} feature coming soon!`);
    }

    function manageSection(id) {
        alert(`Manage Section ${id} feature coming soon!`);
    }

    function viewCourse(id) {
        alert(`View Course ${id} feature coming soon!`);
    }

    function manageCourse(id) {
        alert(`Manage Course ${id} feature coming soon!`);
    }

    function editProfile() {
        alert('Edit Profile feature coming soon!');
    }

    function showMySections() {
        alert('My Sections management feature coming soon!');
    }

    function showMyCourses() {
        alert('My Courses management feature coming soon!');
    }

    function showAssessments() {
        alert('Assessments feature coming soon!');
    }
</script>
{% endblock %}
